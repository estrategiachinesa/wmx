
/**
 * @fileoverview Firestore Security Rules for Estrat√©gia Chinesa.
 *
 * Core Philosophy:
 * This ruleset enforces access control for user data (history), VIP requests,
 * and app configuration. The default state is to deny all access, with explicit
 * permissions granted for specific paths and operations.
 *
 * Data Structure:
 * - /users/{userId}/history/{docId}: Stores signal history for each user.
 * - /appConfig/{configDoc}: Stores global app configuration like affiliate URLs.
 * - /vipRequests/{userId}: Stores VIP access requests.
 *
 * Key Security Decisions:
 * - User data (history) is private. Users can only read and write to their own
 *   history subcollection.
 * - Public read access for app configuration.
 * - Writes to app configuration require authentication.
 * - Users can create or update their own VIP request document in /vipRequests/{userId}
 *   if they are authenticated and the document ID matches their request.auth.uid.
 * - Reading of VIP requests is restricted to the user who owns the document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Rules for the 'users' collection.
     * @path /users/{userId}
     */
    match /users/{userId} {
      // By default, deny read/write to the user document itself.
      // Permissions are granted on subcollections below.
      allow read, write: if false;

      /**
       * @description Rules for the 'history' subcollection.
       * @path /users/{userId}/history/{historyId}
       */
      match /history/{historyId} {
        /**
         * @allow (list, create): A user can list their own history and create new entries.
         *   - The user must be signed in.
         *   - The userId in the path must match the user's UID.
         *   - The data being written must be valid.
         */
        allow list, create: if isSignedIn() && isOwner(userId) && isValidHistoryEntry(request.resource.data);
      }
    }
    
    /**
     * @description Grants public read access to app configuration.
     * @description Allows any user to create the document if it doesn't exist.
     * @description Restricts updates to authenticated users.
     * @path /appConfig/{configDoc}
     */
    match /appConfig/{configDoc} {
      allow read: if true;
      allow create: if true;
      allow update: if isSignedIn();
    }

    /**
     * @description Rules for VIP access requests.
     * @path /vipRequests/{userId}
     */
    match /vipRequests/{userId} {
      /**
       * @allow (get): A user can read their own VIP request document.
       * @allow (write): A user can create or update their own VIP request.
       *   - The user must be signed in.
       *   - The document ID must match the user's UID.
       *   - The brokerId must be a string with at least 8 digits.
       *   - The status can only be set to 'PENDING' by the user on create.
       *   - The status can be set to 'DEPOSIT_PENDING' on update only if the previous status was 'AWAITING_DEPOSIT'.
       */
      allow get: if isSignedIn() && isOwner(userId);
      allow write: if isSignedIn() && isOwner(userId) && isValidVipRequest(request, resource);
    }
    
    // Helper functions.
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isValidHistoryEntry(data) {
      return data.asset is string &&
             data.expirationTime is string &&
             data.signal is string &&
             data.targetTime is string &&
             data.source is string &&
             data.generatedAt == request.time;
    }

    function isValidVipRequest(req, res) {
      let isBrokerIdValid = req.resource.data.brokerId is string &&
                           req.resource.data.brokerId.matches("^[0-9]{8,}$");
      
      let isCreating = req.method == 'create' && 
                       req.resource.data.status == 'PENDING' &&
                       isBrokerIdValid;
      
      let isUpdatingToDepositPending = req.method == 'update' && 
                                       req.resource.data.status == 'DEPOSIT_PENDING' &&
                                       res.data.status == 'AWAITING_DEPOSIT';
                                       
      let isResubmittingRejected = req.method == 'update' &&
                                   res.data.status == 'REJECTED' &&
                                   req.resource.data.status == 'PENDING' &&
                                   isBrokerIdValid;


      return isCreating || isUpdatingToDepositPending || isResubmittingRejected;
    }
  }
}
