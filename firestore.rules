
/**
 * @fileoverview Firestore Security Rules for Chinese Trading Strategies.
 *
 * Core Philosophy:
 * This ruleset enforces access control for Chinese trading strategies and VIP access requests.
 *
 * Data Structure:
 * - `/chineseStrategies/{chineseStrategyId}`: Stores trading strategies.
 * - `/vipRequests/{userId}`: Stores VIP access requests.
 *
 * Key Security Decisions:
 * - Public read access for strategies, but writes require authentication.
 * - Users can create or update their own VIP request document in `/vipRequests/{userId}`
 *   if they are authenticated and the document ID matches their `request.auth.uid`.
 * - Reading of VIP requests is restricted to the user who owns the document,
 *   preventing users from seeing each other's requests.
 *
 * Denormalization for Authorization:
 * No denormalization is needed as authorization is based on authentication state and UID matching.
 *
 * Structural Segregation:
 * - `/chineseStrategies`: For public strategy data.
 * - `/vipRequests`: For private, user-specific VIP requests.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants public read access to Chinese strategies, but restricts writes to authenticated users.
     * @path /chineseStrategies/{chineseStrategyId}
     */
    match /chineseStrategies/{chineseStrategyId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    /**
     * @description Rules for VIP access requests.
     * @path /vipRequests/{userId}
     */
    match /vipRequests/{userId} {
      /**
       * @allow (get): A user can read their own VIP request document.
       * @allow (write): A user can create or update their own VIP request.
       *   - The user must be signed in.
       *   - The document ID must match the user's UID.
       *   - The brokerId must be a string with at least 8 digits.
       *   - The status can only be set to 'PENDING' by the user on create.
       *   - The status can be set to 'DEPOSIT_PENDING' on update.
       */
      allow get: if isSignedIn() && isOwner(userId);
      allow write: if isSignedIn() && isOwner(userId) && isValidVipRequest();
    }

    // Helper functions.
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isValidVipRequest() {
      // Ensure brokerId is a string of at least 8 digits when creating.
      let isBrokerIdValid = request.resource.data.brokerId is string &&
                           request.resource.data.brokerId.matches("^[0-9]{8,}$");
      
      // On create, user must set status to PENDING
      let isCreating = request.method == 'create' && request.resource.data.status == 'PENDING';
      
      // On update, user can only change status to DEPOSIT_PENDING
      let isUpdating = request.method == 'update' && 
                       request.resource.data.status == 'DEPOSIT_PENDING' &&
                       resource.data.status == 'AWAITING_DEPOSIT';

      return isBrokerIdValid && (isCreating || isUpdating);
    }
  }
}
